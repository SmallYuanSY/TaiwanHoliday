name: æ›´æ–°å°ç£æ”¿åºœè¾¦å…¬æ—¥æ›†è¡¨è³‡æ–™

on:
  # æ¯å€‹æœˆåŸ·è¡Œä¸€æ¬¡ï¼ˆæ¯æœˆ1è™Ÿ UTC 00:00ï¼‰
  schedule:
    - cron: '0 0 1 * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  
  # æ¯æ¬¡æ¨é€åˆ°mainåˆ†æ”¯æ™‚ä¹ŸåŸ·è¡Œï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
  push:
    branches: [ main ]

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åŸ·è¡Œçˆ¬èŸ²
      run: |
        python taiwan_holiday_crawler.py
        
    - name: æª¢æŸ¥æ˜¯å¦æœ‰æ–°è³‡æ–™
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "æœ‰æ–°è³‡æ–™æ›´æ–°"
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "æ²’æœ‰æ–°è³‡æ–™"
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: æäº¤æ›´æ–°çš„è³‡æ–™
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/*.csv
        git add data/*.yml
        git add crawler.log
        git commit -m "è‡ªå‹•æ›´æ–°å°ç£æ”¿åºœè¾¦å…¬æ—¥æ›†è¡¨è³‡æ–™ - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        
    - name: å»ºç«‹ç™¼å¸ƒ
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: data-update-${{ github.run_number }}
        release_name: è³‡æ–™æ›´æ–° ${{ github.run_number }}
        body: |
          ğŸ‰ å°ç£æ”¿åºœè¾¦å…¬æ—¥æ›†è¡¨è³‡æ–™å·²è‡ªå‹•æ›´æ–°ï¼
          
          ğŸ“… æ›´æ–°æ™‚é–“ï¼š${{ github.run_time }}
          ğŸ¤– åŸ·è¡Œè€…ï¼šGitHub Actions
          
          ## ğŸ“Š æœ¬æ¬¡æ›´æ–°å…§å®¹
          - ä¸‹è¼‰æœ€æ–°çš„æ”¿åºœè¾¦å…¬æ—¥æ›†è¡¨è³‡æ–™
          - è³‡æ–™ä¾†æºï¼š[æ”¿åºœè³‡æ–™é–‹æ”¾å¹³è‡º](https://data.gov.tw/dataset/14718)
          
          ## ğŸ“ æª”æ¡ˆä½ç½®
          æ›´æ–°çš„è³‡æ–™æª”æ¡ˆä½æ–¼ `data/` ç›®éŒ„ä¸­ã€‚
        draft: false
        prerelease: false 